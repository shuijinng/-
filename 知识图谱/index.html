<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>🎬 电影知识图谱 3D 标签云</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Microsoft YaHei", "SimHei", "PingFang SC", sans-serif;
      background: #000;
      color: #fff;
      overflow: hidden;
    }

    header {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      padding: 20px;
      text-align: center;
      z-index: 10;
      pointer-events: none;
      background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent);
    }

    h1 {
      font-size: 2.2em;
      color: #fff;
      text-shadow: 0 0 10px rgba(0, 200, 255, 0.8);
    }

    /* === 左上角悬浮功能面板 === */
    .floating-panel {
      position: absolute;
      top: 80px;
      left: 20px;
      width: 340px;
      background: rgba(0, 0, 0, 0.8);
      border-radius: 14px;
      padding: 16px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(79, 195, 247, 0.4);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      color: #fff;
      font-size: 0.95em;
      z-index: 10;
      pointer-events: auto;
      transition: transform 0.3s ease;
    }

    .floating-panel:hover {
      transform: translateY(-2px);
    }

    .floating-panel h3 {
      color: #4fc3f7;
      margin-bottom: 8px;
      font-size: 1.1em;
      font-weight: 600;
    }

    .floating-panel textarea,
    .floating-panel input[type="text"] {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 0.95em;
      resize: vertical;
      height: 80px;
      margin-bottom: 8px;
    }

    .floating-panel input[type="text"] {
      height: 40px;
    }

    .floating-panel button {
      margin-top: 8px;
      padding: 8px 16px;
      background: #4fc3f7;
      color: #000;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      transition: 0.2s;
      width: 100%;
    }

    .floating-panel button:hover {
      background: #03a9f4;
      color: white;
    }

    /* 分隔线 */
    .divider {
      height: 1px;
      background: rgba(255, 255, 255, 0.2);
      margin: 12px 0;
    }

    /* === 3D 容器 === */
    #wordcloud-container {
      width: 100vw;
      height: 100vh;
      display: block;
    }

    /* === 信息面板（右侧）=== */
    #info-panel {
      position: fixed;
      right: -1400px;
      top: 100px;
      width: 1400px;
      max-width: 90vw;
      height: 90vh;
      max-height: 800px;
      background: rgba(0, 0, 0, 0.85);
      border-radius: 16px;
      padding: 24px;
      backdrop-filter: blur(12px);
      box-shadow: 0 8px 40px rgba(0, 200, 255, 0.3);
      border: 1px solid rgba(0, 200, 255, 0.4);
      overflow-y: auto;
      z-index: 100;
      font-size: 1em;
      transition: right 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    #info-panel.visible {
      right: 20px;
    }

    #info-panel h3 {
      font-size: 1.3em;
      color: #4fc3f7;
      margin-bottom: 12px;
      border-bottom: 2px solid #4fc3f7;
      padding-bottom: 8px;
    }

    #answer {
      line-height: 1.7;
      color: #e0f7fa;
      white-space: pre-line;
    }

    #graph {
      width: 100%;
      height: 600px;
      margin-top: 20px;
      border-radius: 12px;
      background: #111;
      box-shadow: 0 0 15px rgba(0, 200, 255, 0.1);
    }

    .loading {
      color: #4fc3f7;
      font-style: italic;
    }

    /* === 关闭按钮 === */
    #close-panel {
      position: absolute;
      top: 12px;
      right: 16px;
      width: 32px;
      height: 32px;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.7);
      font-size: 1.5em;
      font-weight: bold;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(4px);
      opacity: 0.8;
      z-index: 100;
    }

    #close-panel:hover {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      transform: scale(1.1);
      opacity: 1;
    }

    #close-panel:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(79, 195, 247, 0.6);
    }

    footer {
      position: absolute;
      bottom: 10px;
      width: 100%;
      text-align: center;
      color: rgba(255, 255, 255, 0.4);
      font-size: 0.9em;
      pointer-events: none;
    }

    /* === 响应式适配 === */
    @media (max-width: 768px) {
      .floating-panel {
        left: 10px;
        width: 280px;
      }
      #info-panel {
        width: 280px;
      }
      #info-panel.visible {
        right: 10px;
      }
      h1 { font-size: 1.6em; }
    }
  </style>
</head>
<body>

  <header>
    <h1>🎬 电影知识图谱 3D 标签云</h1>
  </header>

  <!-- === 左上角悬浮功能面板 === -->
  <div class="floating-panel">
    <!-- 功能1：输入一段话提取实体 -->
    <div class="input-section">
      <h3>📝 提取实体</h3>
      <textarea id="input-text" placeholder="例如：我想看汤姆·汉克斯主演的电影《阿甘正传》"></textarea>
      <button onclick="extractEntitiesFromText()">🔍 提取并查询</button>
    </div>

    <!-- 分隔线 -->
    <div class="divider"></div>

    <!-- 功能2：独立搜索框 -->
    <div class="search-section">
      <h3>🔍 搜索实体</h3>
      <input type="text" id="search-input" placeholder="电影 / 人物 / 公司..." />
      <button onclick="searchEntity()">🔎 搜索</button>
    </div>
  </div>

  <!-- === 3D 标签云容器 === -->
  <div id="wordcloud-container"></div>

  <!-- === 信息面板（右侧）=== -->
  <div id="info-panel">
    <button id="close-panel" aria-label="关闭面板">×</button>
    <div id="answer">📌 点击标签或使用上方功能查看相关信息</div>
    <div id="graph" style="display: none;"></div>
  </div>

  <footer>🔍 使用鼠标拖拽旋转视角，滚轮缩放</footer>

  <!-- 引入 Vis.js 用于知识图谱 -->
  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
  <link href="https://unpkg.com/vis-network/styles/vis-network.min.css" rel="stylesheet" type="text/css" />

  <!-- 主逻辑 -->
  <script type="module">
    import * as THREE from './node_modules/three/build/three.module.js';
    import { OrbitControls } from './node_modules/three/examples/jsm/controls/OrbitControls.js';
    import { Text } from './node_modules/troika-three-text/dist/troika-three-text.esm.js';

    // === 全局变量 ===
    let scene, camera, renderer, controls;
    let network = null;
    const tagObjects = [];
    const infoPanel = document.getElementById('info-panel');
    let allEntityNames = [];

    // === 从后端加载所有实体名 ===
    async function loadEntities() {
      try {
        const res = await fetch("/api/entities");
        const data = await res.json();
        if (data.success) {
          allEntityNames = data.names;
          console.log(`✅ 加载 ${data.count} 个实体用于补全`);
          return data.names;
        } else {
          console.warn("⚠️ 后端返回 success: false", data);
          return [];
        }
      } catch (e) {
        console.error("❌ 加载实体失败:", e);
        return [];
      }
    }

    // === 提取输入文本中的实体 ===
async function extractEntitiesFromText() {
  const text = document.getElementById("input-text").value.trim();
  if (!text) return alert("请输入一段话！");

  // 显示加载中
  showAnswer(`<span class="loading">🔍 正在提取实体...</span>`, null);
  infoPanel.classList.add('visible');

  try {
    const res = await fetch("/api/extract_and_query", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text }),
    });
    const data = await res.json();

    if (data.success) {
      // 构造显示内容
      const personList = data.entities.person.length > 0 ? `<br>👤 NAME: ${data.entities.person.join(', ')}` : '';
      const placeList = data.entities.place.length > 0 ? `<br>📍 地名: ${data.entities.place.join(', ')}` : '';
      const orgList = data.entities.organization.length > 0 ? `<br>🏢 机构名: ${data.entities.organization.join(', ')}` : '';

      const resultHtml = `
        📝 输入文本：<br><em style="color:#aaa;">${data.text}</em>
        <br><br>
        ${personList}
        ${placeList}
        ${orgList}
        <br><br>
        <strong>${data.message}</strong>
      `;
      showAnswer(resultHtml, null); // 第二个参数传 null，不显示图谱
    } else {
      showAnswer(data.error || "⚠️ 未提取到任何实体。", null);
    }
  } catch (error) {
    showAnswer(`❌ 请求失败：${error.message}`, null);
    console.error("Fetch error:", error);
  }
}
    // === 搜索实体 ===
    function searchEntity() {
      const query = document.getElementById("search-input").value.trim();
      if (!query) return alert("请输入要搜索的实体名称！");
      askQuestion(query);
    }

    // === 显示回答和图谱 ===
    function showAnswer(answer, graphData) {
      const answerDiv = document.getElementById("answer");
      const graphDiv = document.getElementById("graph");
      answerDiv.innerHTML = answer;
      graphDiv.style.display = graphData ? "block" : "none";
      if (network) network.destroy();
      if (graphData) drawGraph(graphData);
    }

    // === 向后端提问 ===
    async function askQuestion(entity) {
      showAnswer(`<span class="loading">🔍 正在查询 <strong>${entity}</strong> 的相关信息...</span>`, null);
      try {
        const res = await fetch("/ask", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question: entity }),
        });
        const data = await res.json();

        if (data.answer && data.graph) {
          showAnswer(data.answer, data.graph);
        } else {
          showAnswer(data.answer || "⚠️ 未获取到结果。", null);
        }
        infoPanel.classList.add('visible');
      } catch (error) {
        showAnswer(`❌ 请求失败：${error.message}`, null);
        console.error("Fetch error:", error);
      }
    }

    // === 创建 3D 文本标签 ===
    function createTag(text, x, y, z, onClick) {
      const tag = new Text();
      tag.text = text;
      tag.fontSize = 1.6;

      const hue = Math.random();
      const saturation = 0.8;
      const lightness = 0.7;
      const randomColor = new THREE.Color().setHSL(hue, saturation, lightness);

      tag.material = new THREE.MeshStandardMaterial({
        color: randomColor,
        metalness: 0.3,
        roughness: 0.4
      });
      tag.anchorX = 'center';
      tag.anchorY = 'middle';
      tag.position.set(x, y, z);
      tag.userData = { text, onClick, isBillboard: true };

      scene.add(tag);
      tagObjects.push(tag);
      return tag;
    }

    // === 初始化 3D 标签云 ===
    async function init3DWordCloud(names) {
      const container = document.getElementById("wordcloud-container");
      while (container.firstChild) container.removeChild(container.firstChild);

      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setPixelRatio(window.devicePixelRatio || 1);
      renderer.setSize(container.clientWidth, container.clientHeight);
      renderer.setClearColor(0x000000, 0);
      container.appendChild(renderer.domElement);

      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
      camera.position.z = 25;

      const ambientLight = new THREE.AmbientLight(0x404040, 1);
      scene.add(ambientLight);
      const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
      directionalLight.position.set(10, 10, 10).normalize();
      scene.add(directionalLight);

      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;
      controls.rotateSpeed = 0.5;

      const radius = 14;
      names.forEach((name, i) => {
        const phi = Math.acos(-1 + (2 * i) / names.length);
        const theta = Math.sqrt(names.length * Math.PI) * phi;
        const x = radius * Math.cos(theta) * Math.sin(phi);
        const y = radius * Math.sin(theta) * Math.sin(phi);
        const z = radius * Math.cos(phi);
        createTag(name, x, y, z, () => askQuestion(name));
      });

      renderer.domElement.addEventListener('click', onClick);

      function animate() {
        requestAnimationFrame(animate);
        scene.rotation.y += 0.001;
        tagObjects.forEach(tag => {
          if (tag.userData.isBillboard) {
            tag.lookAt(camera.position);
          }
        });
        controls.update();
        renderer.render(scene, camera);
      }
      animate();

      function onWindowResize() {
        camera.aspect = container.clientWidth / container.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(container.clientWidth, container.clientHeight);
      }

      // === 关闭面板按钮事件 ===
      document.getElementById('close-panel').addEventListener('click', () => {
        infoPanel.classList.remove('visible');
      });

      window.addEventListener('resize', () => {
        setTimeout(onWindowResize, 100);
      }, { passive: true });
    }

    // === 鼠标点击事件 ===
    function onClick(event) {
      const mouse = new THREE.Vector2();
      const rect = renderer.domElement.getBoundingClientRect();
      mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
      mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

      const raycaster = new THREE.Raycaster();
      raycaster.setFromCamera(mouse, camera);

      const intersects = raycaster.intersectObjects(tagObjects);
      if (intersects.length > 0) {
        const tag = intersects[0].object;
        if (tag.userData.onClick) {
          tag.userData.onClick();
        }
      }
    }

    // === 绘制知识图谱 ===
    function drawGraph(graphData) {
      const container = document.getElementById("graph");
      const data = {
        nodes: new vis.DataSet(graphData.nodes),
        edges: new vis.DataSet(graphData.edges)
      };

      const options = {
        nodes: {
          shape: 'dot',
          size: 18,
          font: { size: 14, color: '#ffffff', face: 'Microsoft YaHei' },
          borderWidth: 2,
          shadow: true
        },
        edges: {
  color: { 
    color: '#bbbbbb',     // 边的颜色（浅灰色）
    highlight: '#ffffff'  // 鼠标悬停时边的颜色
  },
  font: {
    size: 10,              // 字体更小（更细）
    color: '#ffffff',      // 字体颜色：纯白（更清晰）
    face: 'Microsoft YaHei', // 使用清晰字体（微软雅黑）
    background: 'rgba(0, 0, 0, 0.5)', // 可选：加一个半透明黑底，让文字更突出
    strokeWidth: 0,        // 文字描边宽度（设为0，更干净）
    align: 'horizontal',   // 文字水平显示（避免旋转）
    vadjust: -2            // 微调文字垂直位置，避免和线重叠
  },
  arrows: { 
    to: { 
      enabled: true, 
      scaleFactor: 0.7     // 箭头小一点，更协调
    } 
  },
  smooth: true,            // 曲线更平滑
  shadow: true,            // 开启阴影，提升层次感
  width: 1                 // 边线细一点
},
        groups: {
          movie: { color: { background: '#e91e63', border: '#c2185b' }, shape: 'ellipse' },
          person: { color: { background: '#4caf50', border: '#388e3c' }, shape: 'icon', icon: { face: 'FontAwesome', code: '\uf007' } },
          company: { color: { background: '#2196f3', border: '#1976d2' }, shape: 'box' }
        },
        physics: {
          repulsion: {
            nodeDistance: 140,
            nodeRepulsion: 1000  // ✅ 已修正为 nodeRepulsion
          },
          stabilization: {
            iterations: 180
          }
        },
        interaction: { hover: true }
      };

      network = new vis.Network(container, data, options);
    }

    // === 启动入口 ===
    window.addEventListener('load', async () => {
      const names = await loadEntities();
      setTimeout(() => init3DWordCloud(names), 100);
    });

    // === 暴露函数到全局作用域（供 HTML onclick 使用）===
    window.extractEntitiesFromText = extractEntitiesFromText;
    window.searchEntity = searchEntity;
  </script>
</body>
</html>